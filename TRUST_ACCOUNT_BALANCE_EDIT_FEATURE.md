# 信托账户直接修改余额功能说明

## 🎯 功能概述

管理员和客户经理可以直接修改信托账户余额，系统会自动创建调整记录并计算差额。

## 📍 功能位置

- ✅ **Admin 页面**：`/admin/trust-account`
- ✅ **Client Manager 页面**：`/client-manager/trust-account`
- ❌ **Client 页面**：不可用（只读）
- ❌ **Surrogacy 页面**：不可用（只读）

## 🎨 UI 界面

### 余额卡片显示
```
┌─────────────────────────────────────────────┐
│ 账户余额                 $10,000.00 [修改余额] │
│ Updated today                               │
└─────────────────────────────────────────────┘
```

### 点击后弹出输入框
```
┌──────────────────────────────────┐
│ 请输入新的账户余额：              │
│ ┌──────────────────────────────┐ │
│ │ 15000                        │ │
│ └──────────────────────────────┘ │
│         [取消]      [确定]        │
└──────────────────────────────────┘
```

## 🔄 工作流程

### 1. 用户操作
```
点击"修改余额"按钮 → 输入新余额 → 确认
```

### 2. 系统自动处理
```typescript
当前余额: $10,000.00
输入余额: $15,000.00
         ↓
自动计算差额: +$5,000.00
         ↓
创建调整记录:
- 类型: OTHER
- 金额: +5000
- 变动前: 10000
- 变动后: 15000
- 收款人: null
- 备注: "余额调整"
- 可见性: true
         ↓
保存到数据库 → 刷新页面
```

## 💡 示例场景

### 场景 1: 增加余额
```
当前余额: $10,000.00
修改为:   $15,000.00
差额:     +$5,000.00 (充值/增加)

生成记录:
- 变动类型: OTHER
- 变动金额: +5000
- 变动前余额: 10000
- 变动后余额: 15000
- 备注: 余额调整
```

### 场景 2: 减少余额
```
当前余额: $10,000.00
修改为:   $7,000.00
差额:     -$3,000.00 (扣除/减少)

生成记录:
- 变动类型: OTHER
- 变动金额: -3000
- 变动前余额: 10000
- 变动后余额: 7000
- 备注: 余额调整
```

### 场景 3: 余额归零
```
当前余额: $10,000.00
修改为:   $0.00
差额:     -$10,000.00

生成记录:
- 变动类型: OTHER
- 变动金额: -10000
- 变动前余额: 10000
- 变动后余额: 0
- 备注: 余额调整
```

## 🌐 国际化

| 元素 | 中文 | English |
|------|------|---------|
| 按钮 | 修改余额 | Edit Balance |
| 提示 | 请输入新的账户余额： | Please enter new account balance: |
| 记录备注 | 余额调整 | Balance Adjustment |
| 失败提示 | 修改余额失败，请重试 | Failed to edit balance, please try again |

## 🔐 权限设计

| 用户角色 | 查看余额 | 修改余额 | 查看记录 | 添加记录 |
|---------|---------|---------|---------|---------|
| Admin | ✅ | ✅ | ✅ | ✅ |
| Manager | ✅ | ✅ | ✅ | ✅ |
| Client | ✅ | ❌ | ✅ (可见记录) | ❌ |
| Surrogacy | ✅ | ❌ | ✅ | ❌ |

## 📊 自动记录字段

修改余额时，系统自动填充以下字段：

| 字段 | 值 | 说明 |
|-----|---|------|
| `change_type` | `'OTHER'` | 固定为"其他"类型 |
| `change_amount` | 计算值 | `新余额 - 当前余额` |
| `balance_before` | 当前余额 | 自动获取最新记录的 `balance_after` |
| `balance_after` | 用户输入 | 用户输入的新余额 |
| `receiver` | `null` | 自动调整无收款人 |
| `remark` | `'余额调整'` | 自动填充 (支持国际化) |
| `visibility` | `'true'` | 默认可见 |

## ✅ 数据验证

### 输入验证
- ✅ 必须是有效数字
- ✅ 可以是正数、负数或零
- ✅ 支持小数
- ❌ 拒绝非数字输入

### 业务规则
- ✅ 自动计算差额（无需手动输入）
- ✅ 保留完整的审计追踪
- ✅ 实时更新余额显示
- ✅ 错误时回滚操作

## 🔍 审计追踪

所有通过"修改余额"功能的操作都会在交易历史中显示：

```
┌────────────────────────────────────────────────────────────┐
│ 日期                类型  金额      收款人  备注            │
├────────────────────────────────────────────────────────────┤
│ 2025-10-20 15:30   其他  +5000.00  -      余额调整         │
│ 2025-10-19 10:15   充值  +10000.00 张三   初始充值         │
└────────────────────────────────────────────────────────────┘
```

## 🎯 使用建议

### 适用场景
1. ✅ **快速余额调整**：发现余额错误需要立即修正
2. ✅ **初始化余额**：新案例需要设置初始余额
3. ✅ **批量导入后调整**：批量导入数据后统一调整
4. ✅ **审计纠错**：发现历史记录错误需要修正

### 不适用场景
1. ❌ **日常充值**：应使用"添加记录"并选择"充值"类型
2. ❌ **日常消费**：应使用"添加记录"并选择"消费"类型
3. ❌ **指定收款人**：如需记录收款人，请使用"添加记录"

## 🛠️ 技术实现

### 核心函数
```typescript
const handleBalanceEdit = async (newBalance: number) => {
  // 1. 获取当前余额
  const currentBalance = getCurrentBalance();
  
  // 2. 计算差额
  const changeAmount = newBalance - currentBalance;
  
  // 3. 创建调整记录
  await createBalanceChange({
    change_type: 'OTHER',
    change_amount: changeAmount,
    balance_before: currentBalance,
    balance_after: newBalance,
    receiver: null,
    remark: t('trustAccount.balanceAdjustment'),
    visibility: 'true',
  });
  
  // 4. 刷新数据
  await fetchChanges();
};
```

### API 调用
```typescript
POST /api/trust-account/change
Content-Type: application/json

{
  "caseId": 123,
  "change_type": "OTHER",
  "change_amount": 5000,
  "balance_before": 10000,
  "balance_after": 15000,
  "receiver": null,
  "remark": "余额调整",
  "visibility": "true"
}
```

## 🎉 优势特性

1. **简化操作**：无需手动计算差额
2. **自动记录**：完整保留操作历史
3. **权限控制**：仅管理员可用
4. **国际化支持**：中英文界面
5. **错误处理**：友好的错误提示
6. **实时更新**：即时显示最新余额

---

**注意**：此功能仅用于管理目的，所有操作都会被完整记录并可追溯。建议在使用前确认新余额的正确性。

